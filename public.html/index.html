<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<!--
    to view this webpage, run a local python server:
    open this project in an integrated terminal,
    > python3 -m http.server 8000
    use the url:
    http://localhost:8000/public.html/index.html

    or, alternatively, use the url: 
    file:///home/ambrose/Documents/GitHub/cactus-website/public.html/index.html

    warm wishes,
    ambrose sturgill
-->

<head>
    <title>Ancient Tech</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Shop san pedro cactus here" />
    <meta name="keywords" content="Trichocereus, Pachanoi, Bridgesii, Peruvianus, San Pedro, Cactus, Variegated, Crested, Seedlings" />
    <link href="/static/css/normalize.css"
          type="text/css" rel="stylesheet" />
    <link href="/static/css/main.css"
          type="text/css" rel="stylesheet" />
</head>

<body>

    <header>
        <nav>
            <a href="#seedlings">Seedlings</a> /
            <a href="#clones">Clones</a> /
            <a href="#mutated">Crested-Mutated</a> /
            <a href="#order_info">Order Info</a> /
            <a href="#about">About Us</a>
        </nav>
        <p id="contact">
            For orders and inquiries contact us at 
            <a href="mailto:ancienttechcultivation@gmail.com">ancienttechcultivation@gmail.com</a>
        </p>
    </header>

    <aside>
        <p> You receive exact cactus shown. </p>
    </aside>

    <main>
        <section id="seedlings">
            <h1> Seedlings </h1>
            <div class="grid">
            </div>
        </section>
        <section id="clones">
            <h1> Clones </h1>
            <div class="grid"></div>
        </section>
        <section id="mutated">
            <h1> Crested and Mutated </h1>
            <div class="grid"></div>
        </section>
        <section id="order_info">
            <h1> Order Information </h1>
        </section>
        <section id="about">
            <h1> About Us </h1>
            <p>[hank slideshow]</p>
        </section>
    </main>

    <footer>
        <hr />
        <p>
            work in progress.
            <!-- Credit to my son Ambrose who made this kickass website. -->
        </p>
    </footer>
</body>

<script type="text/javascript">
"use strict";

    class Listing {
        constructor(myNumber, myCategory, myDescription, myPrice, mySold, myUrl) {
            this.itemNumber = myNumber;
            this.category = myCategory;
            this.description = myDescription;
            this.price = myPrice;
            this.isSold = mySold;
            this.imageUrl = myUrl;
        }
    }
    /* For a listing to have responsive images, 
       it requires imageUrl attributes for each resolution expected. 
       change should be made in future iteration 
       https://developer.mozilla.org/en-US/docs/Web/HTML/Guides/Responsive_images */

    /* expects listings.xml to be stored locally 
       and returns an XML document */
    async function fetchListings() {
        try {
            const response = await fetch('/static/xml/listings.xml?v=6');
            if (!response.ok) {
                throw new Error(`XML fetch error: ${response.status}`);
            }
            const xmlString = await response.text();
            const parser = new DOMParser();
            return parser.parseFromString(xmlString, "text/xml");

        } catch (error) {
            console.error("XML fetch or parse error: ", error);
        }
    }

    /* expects an XML document
       and returns an array of Listing instances */
    function populateListings(xmlDocument) {
        const listings = [];
        const listingElements = xmlDocument.getElementsByTagName("listing");

        for (const element of listingElements) {
            const myNumber = element.getElementsByTagName("itemNumber")[0]?.textContent || "MISSING";
            const myCategory = element.getElementsByTagName("category")[0]?.textContent || "uncategorized";
            const myDescription = element.getElementsByTagName("description")[0]?.textContent || "Description coming soon.";
            const myPrice = element.getElementsByTagName("price")[0]?.textContent || 0;
            const mySold = element.getElementsByTagName("isSold")[0]?.textContent === "true" || false;
            const myUrl = element.getElementsByTagName("imageUrl")[0]?.textContent || "/static/images/missing_image.png";

            const newListing = new Listing(myNumber, myCategory, myDescription, myPrice, mySold, myUrl);
            listings.push(newListing);
        }

        return listings.length > 0 ? listings : null;
    }

    /* expects listings.xml to be stored locally 
       and returns an array of Listing instances */
    async function getListingsArray() {
        try {
            const xmlDoc = await fetchListings();
            if (!xmlDoc || xmlDoc.getElementsByTagName("listing").length === 0) {
                console.error("No listings found in XML document");
                return [];
            }
            const listings = populateListings(xmlDoc);
            return listings;
        }
        catch (error) {
            console.error("Error in getListingsArray: ", error);
        }
    }

    /* expects an array of Listing instances
       and populates DOM sections with listings in the form:
            <div class="listing">
                <p class="listing_number">`${listing.itemNumber}`</p>
                <img src=`${listing.imageUrl}` class="listing_thumb" />
                <p class="listing_description">`${listing.description}`</p>
                <p class="listing_price">$`${listing.price}`</p>
            </div> */
    async function generateListingHtml(listings) {
        for (const listing of listings) {
            // create elements
            const section = document.getElementById(`${listing.category}`);
            if (section) {
                const grid = section.getElementsByClassName("grid")[0];
                if (grid) {
                    const listingDiv = document.createElement("div");
                    listingDiv.setAttribute('class', 'listing');
                    const listingNumber = document.createElement("p", {class: "listing_number"});
                    listingNumber.setAttribute('class', 'listing_number');
                    listingNumber.textContent = `${listing.itemNumber}`;
                    const listingThumb = document.createElement("img");
                    listingThumb.setAttribute('src', `${listing.imageUrl}`);
                    listingThumb.setAttribute('class', 'listing_thumb');
                    const listingDescription = document.createElement("p");
                    listingDescription.setAttribute('class', 'listing_description');
                    listingDescription.textContent = `${listing.description}`;
                    const listingPrice = document.createElement("p");
                    listingPrice.setAttribute('class', 'listing_price');
                    const formatted_price = new Intl.NumberFormat("US", {style: "currency", currency: "USD", currencyDisplay: "narrowSymbol"}).format(`${listing.price}`);
                    listingPrice.textContent = formatted_price;
                    // place elements
                    grid.appendChild(listingDiv);
                    listingDiv.appendChild(listingNumber);
                    listingDiv.appendChild(listingThumb);
                    listingDiv.appendChild(listingDescription);
                    listingDiv.appendChild(listingPrice);
                } else {
                    console.error("Error in generateListingHtml: Grid could not be found for listing: ", `${listing.itemNumber}`, " - ", `${listing.category}`);
                } 
            } else {
                console.error("Error in generateListingHtml: Section could not be found for Listing: ", `${listing.itemNumber}`, " - ", `${listing.category}`);
            }

        }
    }

    async function main() {
        const listings = await getListingsArray();
        generateListingHtml(listings);
        shrinkWrap(document.querySelector("p"));
        storeHeaderHeight();
        asideWrap();
    }

    /* updates the CSS variable --header-height
       to contain the current the height of the header, 
       including vertical padding and borders */
    function storeHeaderHeight() {
        const header = document.querySelector("header");
        const height = header.offsetHeight;
        const root = document.documentElement;
        root.style.setProperty('--header-height', `${height}px`);
    }

    /* compares the heights of the header elements
       if flex-wrap occurs, align the aside left,
       otherwise align the aside right */
    function asideWrap() {
        const nav = document.querySelector("nav").getBoundingClientRect();
        const contact = document.getElementById("contact").getBoundingClientRect();;
        const aside = document.querySelector("aside");
        if (contact.top > nav.top) {
            aside.style.justifyContent = "left";
        } else {
            aside.style.justifyContent = "right";
        }
    }

    /* expects an element
       and reduces width of the element to the element's content width.
       Credit to Jake Meyers and V. Rubinetti 4.10.24
       https://stackoverflow.com/questions/14596213/ */
    function shrinkWrap(element) {
        const {firstChild, lastChild} = element;
        if (!element || !firstChild || !lastChild) return;

        element.style.width = 'auto';

        const range = document.createRange();
        range.setStartBefore(firstChild);
        range.setEndAfter(lastChild);
        const {width} = range.getBoundingClientRect();
        element.style.width = width + "px";
        element.style.boxSizing = "content-box";
    };

    main();

    window.addEventListener('resize', () => {
        // shrinkwrap all paragraphs
        const paragraphs = document.querySelectorAll("p");
        paragraphs.forEach(paragraph => shrinkWrap(paragraph));
        const navs = document.querySelectorAll("nav");
        navs.forEach(nav => shrinkWrap(nav));

        // attach aside to header
        storeHeaderHeight();
        asideWrap();
    });
</script>

</html>