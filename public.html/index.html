<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<!--
    to view this webpage, run a local python server:
    open this project in an integrated terminal,
    > python3 -m http.server 8000
    use the url:
    http://localhost:8000/public.html/index.html

    or, alternatively, use the url: 
    file:///home/ambrose/Documents/GitHub/cactus-website/public.html/index.html

    warm wishes,
    ambrose sturgill
-->

<head>
    <title>ATC</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Shop san pedro cactus here" />
    <meta name="keywords" content="Trichocereus, Pachanoi, Bridgesii, Peruvianus, San Pedro, Cactus, Variegated, Crested, Seedlings" />
    <link href="/static/css/normalize.css"
          type="text/css" rel="stylesheet" />
    <link href="/static/css/main.css"
          type="text/css" rel="stylesheet" />
</head>

<body>

    <header>
        <nav>
            <a href="#seedlings">Seedlings</a> /
            <a href="#clones">Clones</a> /
            <a href="#mutated">Crested-Mutated</a> /
            <a href="#about">About Us</a>
        </nav>
        <p>
            For orders and inquiries contact us at 
            <a href="mailto:ancienttechcultivation@gmail.com">ancienttechcultivation@gmail.com</a>
        </p>
    </header>

    <main>
        <section id="seedlings">
            <h1> Seedlings </h1>
        </section>
        <section id="clones">
            <h1> Clones </h1>
        </section>
        <section id="mutated">
            <h1> Crested-Mutated </h1>
        </section>
        <section id="about">
            <h1> About Us </h1>
        </section>
    </main>

    <footer>
        <hr />
        <p>
            work in progress.
        </p>
    </footer>
</body>

<script type="text/javascript">
"use strict";

    class Listing {
        constructor(myNumber, myCategory, myDescription, myPrice, mySold, myUrl) {
            this.itemNumber = myNumber;
            this.category = myCategory;
            this.description = myDescription;
            this.price = myPrice;
            this.isSold = mySold;
            this.imageUrl = myUrl;
        }
    }
    /* For a listing to have responsive images, 
       it requires imageUrl attributes for each resolution expected. 
       change should be made in future iteration 
       https://developer.mozilla.org/en-US/docs/Web/HTML/Guides/Responsive_images */

    /* expects listings.xml to be stored locally 
       and returns an XML document */
    async function fetchListings() {
        try {
            const response = await fetch('/static/xml/listings.xml?v=1');
            if (!response.ok) {
                throw new Error(`XML fetch error: ${response.status}`);
            }
            const xmlString = await response.text();
            const parser = new DOMParser();
            return parser.parseFromString(xmlString, "text/xml");

        } catch (error) {
            console.error("XML fetch or parse error: ", error);
        }
    }

    /* expects an XML document
       and returns an array of Listing instances */
    function populateListings(xmlDocument) {
        const listings = [];
        const listingElements = xmlDocument.getElementsByTagName("listing");

        for (const element of listingElements) {
            const myNumber = element.getElementsByTagName("itemNumber")[0]?.textContent || "MISSING";
            const myCategory = element.getElementsByTagName("category")[0]?.textContent || "uncategorized";
            const myDescription = element.getElementsByTagName("description")[0]?.textContent || "No description available.";
            const myPrice = element.getElementsByTagName("price")[0]?.textContent || 0;
            const mySold = element.getElementsByTagName("isSold")[0]?.textContent === "true" || false;
            const myUrl = element.getElementsByTagName("imageUrl")[0]?.textContent || "/static/images/missing_image.png";

            const newListing = new Listing(myNumber, myCategory, myDescription, myPrice, mySold, myUrl);
            listings.push(newListing);
        }

        return listings.length > 0 ? listings : null;
    }

    /* expects listings.xml to be stored locally 
       and returns an array of Listing instances */
    async function getListingsArray() {
        try {
            const xmlDoc = await fetchListings();
            if (!xmlDoc || xmlDoc.getElementsByTagName("listing").length === 0) {
                console.error("No listings found in XML document");
                return [];
            }
            const listings = populateListings(xmlDoc);
            return listings;
        }
        catch (error) {
            console.error("Error in getListingsArray: ", error);
        }
    }

    /* expects an array of Listing instances
       and generates html */
    async function generateListingHtml(listings) {
        for (const listing of listings) {
            const testP = document.createElement("p");
            testP.textContent = `[${listing.itemNumber}] ${listing.description} - $${listing.price}`;
            const testImg = document.createElement("img");
            testImg.src = `${listing.imageUrl}`;
            const section = document.getElementById(`${listing.category}`);
            section.appendChild(testP);
            section.appendChild(testImg);
        }
    }

    async function main() {
        const listings = await getListingsArray();
        generateListingHtml(listings);
    }

    main();
</script>

</html>